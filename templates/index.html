<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ• PizzaVoice</title>
  <style>
    :root {
      --red:    #e63946;
      --orange: #f4a261;
      --cream:  #fdf8f0;
      --dark:   #1d1d1d;
      --mid:    #444;
      --light:  #f1f1f1;
      --radius: 16px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: var(--cream);
      color: var(--dark);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* â”€â”€ Header â”€â”€ */
    header {
      background: var(--red);
      color: #fff;
      padding: 14px 24px;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,.2);
    }
    header h1 { font-size: 1.4rem; font-weight: 700; }
    header span.logo { font-size: 1.8rem; }
    .status-dot {
      width: 10px; height: 10px;
      background: #4ade80;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%,100% { opacity: 1; } 50% { opacity: .4; }
    }

    /* â”€â”€ Mode toggle in header â”€â”€ */
    .header-right {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    #mode-toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      background: rgba(255,255,255,.18);
      border: 1.5px solid rgba(255,255,255,.35);
      border-radius: 24px;
      padding: 5px 14px;
      color: #fff;
      font-size: .82rem;
      font-weight: 600;
      cursor: pointer;
      transition: background .2s, border-color .2s;
      user-select: none;
    }
    #mode-toggle:hover { background: rgba(255,255,255,.28); }
    #mode-toggle .icon { font-size: 1.05rem; }
    #mode-toggle.voice-active { background: rgba(255,255,255,.32); border-color: #fff; }

    /* â”€â”€ Voice status badge â”€â”€ */
    #voice-status {
      font-size: .72rem;
      padding: 3px 10px;
      border-radius: 12px;
      background: rgba(255,255,255,.15);
      color: rgba(255,255,255,.7);
      display: none;
    }
    #voice-status.listening {
      display: inline-block;
      background: rgba(74,222,128,.25);
      color: #4ade80;
      animation: pulse 1.5s infinite;
    }
    #voice-status.speaking {
      display: inline-block;
      background: rgba(244,162,97,.25);
      color: var(--orange);
    }

    /* â”€â”€ Main layout â”€â”€ */
    main {
      flex: 1;
      display: flex;
      gap: 0;
      overflow: hidden;
    }

    /* â”€â”€ Chat panel â”€â”€ */
    #chat-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }
    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    .msg {
      max-width: 75%;
      padding: 12px 16px;
      border-radius: var(--radius);
      line-height: 1.5;
      font-size: .95rem;
      animation: fadein .25s ease;
    }
    @keyframes fadein { from { opacity:0; transform:translateY(6px); } to { opacity:1; } }
    .msg.bot {
      background: #fff;
      border: 1px solid #e5e5e5;
      border-bottom-left-radius: 4px;
      align-self: flex-start;
    }
    .msg.user {
      background: var(--red);
      color: #fff;
      border-bottom-right-radius: 4px;
      align-self: flex-end;
    }
    .msg.bot .avatar {
      font-size: 1.1rem;
      margin-right: 6px;
    }
    /* speaker icon on bot messages */
    .msg.bot .speak-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: .85rem;
      margin-left: 8px;
      opacity: .5;
      transition: opacity .2s;
      vertical-align: middle;
    }
    .msg.bot .speak-btn:hover { opacity: 1; }

    /* typing indicator */
    .typing { display: flex; gap: 5px; padding: 14px 18px; align-items: center; }
    .typing span {
      width: 8px; height: 8px;
      background: #ccc;
      border-radius: 50%;
      animation: bounce 1.2s infinite;
    }
    .typing span:nth-child(2) { animation-delay: .2s; }
    .typing span:nth-child(3) { animation-delay: .4s; }
    @keyframes bounce {
      0%,80%,100% { transform: translateY(0); }
      40%          { transform: translateY(-8px); }
    }

    /* â”€â”€ Input bar â”€â”€ */
    #input-bar {
      padding: 14px 20px;
      background: #fff;
      border-top: 1px solid #e5e5e5;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    #user-input {
      flex: 1;
      padding: 12px 16px;
      border: 1.5px solid #ddd;
      border-radius: 30px;
      font-size: .95rem;
      outline: none;
      transition: border-color .2s;
    }
    #user-input:focus { border-color: var(--red); }
    #send-btn {
      background: var(--red);
      color: #fff;
      border: none;
      padding: 12px 22px;
      border-radius: 30px;
      font-size: .95rem;
      font-weight: 600;
      cursor: pointer;
      transition: background .2s, transform .1s;
    }
    #send-btn:hover  { background: #c1121f; }
    #send-btn:active { transform: scale(.97); }
    #send-btn:disabled { background: #aaa; cursor: not-allowed; }

    /* â”€â”€ Mic button â”€â”€ */
    #mic-btn {
      width: 48px; height: 48px;
      border-radius: 50%;
      border: none;
      background: var(--red);
      color: #fff;
      font-size: 1.3rem;
      cursor: pointer;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background .2s, transform .15s, box-shadow .2s;
      position: relative;
    }
    #mic-btn:hover { background: #c1121f; transform: scale(1.05); }
    #mic-btn:active { transform: scale(.95); }
    #mic-btn.recording {
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34,197,94,.3);
      animation: mic-pulse 1.2s infinite;
    }
    @keyframes mic-pulse {
      0%,100% { box-shadow: 0 0 0 4px rgba(34,197,94,.3); }
      50%     { box-shadow: 0 0 0 10px rgba(34,197,94,.08); }
    }
    #mic-btn:disabled { background: #aaa; cursor: not-allowed; box-shadow: none; animation: none; }

    /* hide text input in voice mode */
    body.voice-mode #user-input { display: none; }
    body.voice-mode #send-btn   { display: none; }
    body.voice-mode #mic-btn    { width: 56px; height: 56px; font-size: 1.5rem; }

    /* hide mic in text mode */
    body.text-mode #mic-btn { display: none; }

    /* live transcript preview */
    #live-transcript {
      flex: 1;
      font-size: .9rem;
      color: #999;
      font-style: italic;
      padding: 0 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: none;
    }
    body.voice-mode #live-transcript { display: block; }

    /* â”€â”€ Receipt panel â”€â”€ */
    #receipt-panel {
      width: 340px;
      background: #fff;
      border-left: 1px solid #e5e5e5;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      transition: width .3s;
    }
    #receipt-panel.empty {
      display: flex;
      align-items: center;
      justify-content: center;
      color: #bbb;
      font-size: .9rem;
      text-align: center;
      padding: 20px;
    }
    #receipt-panel.empty::after {
      content: "ğŸ•\nYour order receipt\nwill appear here";
      white-space: pre;
      line-height: 2;
    }
    #receipt-content { padding: 20px; }
    .receipt-header {
      text-align: center;
      border-bottom: 2px dashed #eee;
      padding-bottom: 14px;
      margin-bottom: 14px;
    }
    .receipt-header h2 { color: var(--red); font-size: 1.3rem; }
    .receipt-header p  { color: #888; font-size: .8rem; margin-top: 4px; }
    .receipt-section   { margin-bottom: 12px; }
    .receipt-section h3 {
      font-size: .75rem;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: #999;
      margin-bottom: 6px;
    }
    .receipt-row {
      display: flex;
      justify-content: space-between;
      font-size: .9rem;
      padding: 3px 0;
    }
    .receipt-row.total {
      font-weight: 700;
      font-size: 1.05rem;
      border-top: 2px solid var(--dark);
      padding-top: 8px;
      margin-top: 4px;
    }
    .receipt-row.tax { color: #888; font-size: .85rem; }
    .topping-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: var(--light);
      padding: 3px 10px;
      border-radius: 20px;
      font-size: .82rem;
      margin: 3px 3px 3px 0;
    }
    .order-id {
      text-align: center;
      margin-top: 16px;
      font-size: .78rem;
      color: #bbb;
      letter-spacing: .05em;
    }

    /* â”€â”€ Responsive â”€â”€ */
    @media (max-width: 640px) {
      #receipt-panel { width: 0; overflow: hidden; border: none; }
    }
  </style>
</head>
<body class="voice-mode">

<header>
  <span class="logo">ğŸ•</span>
  <h1>PizzaVoice</h1>
  <div class="header-right">
    <span id="voice-status"></span>
    <button id="mode-toggle" class="voice-active" title="Switch between Voice and Text mode">
      <span class="icon">ğŸ™ï¸</span> <span id="mode-label">Voice</span>
    </button>
    <div class="status-dot" title="Online"></div>
  </div>
</header>

<main>
  <!-- Chat -->
  <section id="chat-panel">
    <div id="messages"></div>
    <div id="input-bar">
      <input id="user-input" type="text" placeholder="Type your messageâ€¦" autocomplete="off"/>
      <span id="live-transcript">Tap the mic &amp; speakâ€¦</span>
      <button id="mic-btn" title="Hold or tap to speak">ğŸ¤</button>
      <button id="send-btn">Send</button>
    </div>
  </section>

  <!-- Receipt -->
  <aside id="receipt-panel" class="empty"></aside>
</main>

<script>
  const messagesEl    = document.getElementById("messages");
  const inputEl       = document.getElementById("user-input");
  const sendBtn       = document.getElementById("send-btn");
  const receiptEl     = document.getElementById("receipt-panel");
  const micBtn        = document.getElementById("mic-btn");
  const modeToggle    = document.getElementById("mode-toggle");
  const modeLabel     = document.getElementById("mode-label");
  const voiceStatus   = document.getElementById("voice-status");
  const liveTranscript = document.getElementById("live-transcript");

  let history = [];
  let voiceMode = true;               // voice is DEFAULT

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // TEXT-TO-SPEECH  (female voice)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  let femaleVoice = null;
  let ttsEnabled  = true;             // auto-speak bot replies when voice mode

  function loadVoices() {
    const voices = speechSynthesis.getVoices();
    if (!voices.length) return;

    // Preference order:  English female voices
    const prefs = [
      v => /zira/i.test(v.name),                                     // Windows "Zira"
      v => /samantha/i.test(v.name),                                  // macOS "Samantha"
      v => /google.*female/i.test(v.name),                            // Chrome "Google UK English Female"
      v => /google.*uk.*english/i.test(v.name) && /female/i.test(v.name),
      v => /female/i.test(v.name) && /en/i.test(v.lang),
      v => /woman/i.test(v.name)  && /en/i.test(v.lang),
      v => (/en[-_]/i.test(v.lang)) && !/(male|david|mark|james|daniel|guy|richard)/i.test(v.name),
      v => /en[-_]/i.test(v.lang),
    ];
    for (const test of prefs) {
      const match = voices.find(test);
      if (match) { femaleVoice = match; break; }
    }
    if (!femaleVoice) femaleVoice = voices[0];
    console.log("[TTS] Selected voice:", femaleVoice?.name);
  }
  speechSynthesis.addEventListener("voiceschanged", loadVoices);
  loadVoices();

  function speak(text) {
    if (!ttsEnabled || !voiceMode) return;
    speechSynthesis.cancel();                      // stop any ongoing speech
    const clean = text.replace(/[#*_~`>]/g, "")    // strip markdown-ish chars
                      .replace(/\bhttps?:\/\/\S+/g, "link");
    const utt   = new SpeechSynthesisUtterance(clean);
    if (femaleVoice) utt.voice = femaleVoice;
    utt.rate  = 1.02;
    utt.pitch = 1.12;                             // slightly higher = more feminine
    utt.lang  = "en-US";
    utt.onstart = () => setVoiceStatus("speaking", "ğŸ”Š Speakingâ€¦");
    utt.onend   = () => setVoiceStatus("idle");
    utt.onerror = () => setVoiceStatus("idle");
    speechSynthesis.speak(utt);
  }

  function stopSpeaking() { speechSynthesis.cancel(); setVoiceStatus("idle"); }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // SPEECH-TO-TEXT  (Web Speech API)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  let recognition = null;
  let isRecording  = false;

  if (SpeechRecognition) {
    recognition = new SpeechRecognition();
    recognition.continuous   = false;
    recognition.interimResults = true;
    recognition.lang         = "en-US";

    recognition.onresult = (e) => {
      let interim = "", final_ = "";
      for (let i = e.resultIndex; i < e.results.length; i++) {
        const t = e.results[i][0].transcript;
        if (e.results[i].isFinal) final_ += t;
        else                      interim += t;
      }
      liveTranscript.textContent = interim || final_ || "Listeningâ€¦";
      if (final_) {
        stopRecording();
        inputEl.value = final_;
        send();
      }
    };
    recognition.onerror = (e) => {
      console.warn("[STT] Error:", e.error);
      stopRecording();
      if (e.error === "not-allowed") {
        addMsg("bot", "âš ï¸ Microphone access was denied.\nPlease allow mic permission or switch to Text mode.");
      }
    };
    recognition.onend = () => { stopRecording(); };
  }

  function startRecording() {
    if (!recognition) {
      addMsg("bot", "âš ï¸ Your browser doesn't support speech recognition.\nPlease switch to Text mode.");
      return;
    }
    stopSpeaking();                               // don't listen to yourself
    isRecording = true;
    micBtn.classList.add("recording");
    liveTranscript.textContent = "Listeningâ€¦";
    setVoiceStatus("listening", "ğŸ™ï¸ Listeningâ€¦");
    try { recognition.start(); } catch(_) {}      // ignore "already started"
  }

  function stopRecording() {
    isRecording = false;
    micBtn.classList.remove("recording");
    liveTranscript.textContent = "Tap the mic & speakâ€¦";
    setVoiceStatus("idle");
    try { recognition.stop(); } catch(_) {}
  }

  // Mic button: tap to toggle
  micBtn.addEventListener("click", () => {
    if (isRecording) stopRecording();
    else             startRecording();
  });

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // MODE TOGGLE  (Voice â†” Text)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function setMode(mode) {
    voiceMode = mode === "voice";
    document.body.className = voiceMode ? "voice-mode" : "text-mode";
    modeLabel.textContent   = voiceMode ? "Voice" : "Text";
    modeToggle.querySelector(".icon").textContent = voiceMode ? "ğŸ™ï¸" : "âŒ¨ï¸";
    modeToggle.classList.toggle("voice-active", voiceMode);
    if (!voiceMode) {
      stopRecording();
      stopSpeaking();
      setVoiceStatus("idle");
      inputEl.focus();
    }
  }

  modeToggle.addEventListener("click", () => {
    setMode(voiceMode ? "text" : "voice");
  });

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // VOICE STATUS BADGE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function setVoiceStatus(state, label) {
    voiceStatus.className = "";
    voiceStatus.style.display = "none";
    if (state === "listening") {
      voiceStatus.textContent = label || "ğŸ™ï¸ Listeningâ€¦";
      voiceStatus.className = "listening";
      voiceStatus.style.display = "inline-block";
    } else if (state === "speaking") {
      voiceStatus.textContent = label || "ğŸ”Š Speakingâ€¦";
      voiceStatus.className = "speaking";
      voiceStatus.style.display = "inline-block";
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CHAT RENDERING
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function addMsg(role, text) {
    const div = document.createElement("div");
    div.className = `msg ${role}`;
    if (role === "bot") {
      // Add a small speaker button so user can re-play any bot message
      div.innerHTML = `<span class="avatar">ğŸ‘©â€ğŸ³</span>${escHtml(text)}<button class="speak-btn" title="Read aloud">ğŸ”Š</button>`;
      div.querySelector(".speak-btn").addEventListener("click", () => {
        ttsEnabled = true;
        const wasVoice = voiceMode;
        voiceMode = true;                // temporarily enable for this click
        speak(text);
        voiceMode = wasVoice;
      });
    } else {
      div.textContent = text;
    }
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;
    return div;
  }

  function escHtml(s) {
    return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
            .replace(/\n/g,"<br>");
  }

  // â”€â”€ Typing indicator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showTyping() {
    const d = document.createElement("div");
    d.className = "msg bot typing";
    d.id = "typing";
    d.innerHTML = "<span></span><span></span><span></span>";
    messagesEl.appendChild(d);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }
  function hideTyping() {
    const t = document.getElementById("typing");
    if (t) t.remove();
  }

  // â”€â”€ Render receipt â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderReceipt(r) {
    receiptEl.classList.remove("empty");
    const o = r.order, p = r.pricing;
    const fmt = n => `$${n.toFixed(2)}`;

    let topsHtml = o.toppings.length
      ? o.toppings.map(t=>`<span class="topping-chip">${t.emoji} ${t.label} <em style="color:#999">${fmt(t.price)}</em></span>`).join("")
      : `<span style="color:#bbb;font-size:.85rem">None</span>`;

    let drinksHtml = (o.drinks && o.drinks.length)
      ? o.drinks.map(d=>`<span class="topping-chip">${d.emoji} ${d.label} <em style="color:#999">${fmt(d.price)}</em></span>`).join("")
      : `<span style="color:#bbb;font-size:.85rem">None</span>`;

    let extrasHtml = o.extras.length
      ? o.extras.map(e=>`<div class="receipt-row"><span>${e.label}</span><span>${e.price?fmt(e.price):"free"}</span></div>`).join("")
      : "";

    receiptEl.innerHTML = `<div id="receipt-content">
      <div class="receipt-header">
        <h2>ğŸ• Order Confirmed!</h2>
        <p>${r.timestamp}</p>
        <p style="margin-top:6px;font-size:.9rem">Hey <strong>${o.name}</strong>! Here's your order ğŸ‘‡</p>
      </div>

      <div class="receipt-section">
        <h3>Pizza Details</h3>
        <div class="receipt-row"><span>Size</span><span>${o.size.label}</span></div>
        <div class="receipt-row"><span>Crust</span><span>${o.crust.label}</span></div>
        <div class="receipt-row"><span>Sauce</span><span>${o.sauce.label}</span></div>
        <div class="receipt-row"><span>Cheese</span><span>${o.cheese.label}</span></div>
        <div class="receipt-row"><span>Qty</span><span>Ã— ${o.quantity}</span></div>
      </div>

      <div class="receipt-section">
        <h3>Toppings</h3>
        <div>${topsHtml}</div>
      </div>

      <div class="receipt-section">
        <h3>ğŸ¥¤ Drinks</h3>
        <div>${drinksHtml}</div>
      </div>

      ${extrasHtml ? `<div class="receipt-section"><h3>Extras</h3>${extrasHtml}</div>` : ""}

      <div class="receipt-section">
        <h3>ğŸ“ Delivery Address</h3>
        <p style="font-size:.9rem;color:var(--mid);line-height:1.5">${escHtml(o.address || 'Pick-up')}</p>
      </div>

      <div class="receipt-section">
        <h3>Pricing</h3>
        <div class="receipt-row"><span>Base price</span><span>${fmt(p.breakdown.base)}</span></div>
        ${p.breakdown.crust   ? `<div class="receipt-row"><span>Crust upgrade</span><span>+${fmt(p.breakdown.crust)}</span></div>` : ""}
        ${p.breakdown.sauce   ? `<div class="receipt-row"><span>Sauce upgrade</span><span>+${fmt(p.breakdown.sauce)}</span></div>` : ""}
        ${p.breakdown.cheese  ? `<div class="receipt-row"><span>Cheese upgrade</span><span>+${fmt(p.breakdown.cheese)}</span></div>` : ""}
        ${p.breakdown.toppings? `<div class="receipt-row"><span>Toppings</span><span>+${fmt(p.breakdown.toppings)}</span></div>` : ""}
        ${p.breakdown.drinks  ? `<div class="receipt-row"><span>Drinks</span><span>+${fmt(p.breakdown.drinks)}</span></div>` : ""}
        ${p.breakdown.extras  ? `<div class="receipt-row"><span>Extras</span><span>+${fmt(p.breakdown.extras)}</span></div>` : ""}
        ${p.quantity > 1      ? `<div class="receipt-row"><span>Unit price Ã— ${p.quantity}</span><span>${fmt(p.unit)} Ã— ${p.quantity}</span></div>` : ""}
        <div class="receipt-row"><span>Subtotal</span><span>${fmt(p.subtotal)}</span></div>
        <div class="receipt-row tax"><span>Tax (13%)</span><span>${fmt(p.tax)}</span></div>
        <div class="receipt-row total"><span>ğŸ’° Total Due</span><span style="color:var(--red);font-size:1.15rem">${fmt(p.total)}</span></div>
      </div>

      <div style="text-align:center;margin:16px 0 8px;padding:12px 10px;background:linear-gradient(135deg,#fff8f0,#fff3e0);border-radius:12px;border:1px dashed var(--orange)">
        <p style="font-style:italic;font-size:.88rem;color:var(--mid);line-height:1.6">${escHtml(r.quote || '')}</p>
      </div>

      <div class="order-id">Order #${r.order_id}</div>
    </div>`;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // SEND MESSAGE  (works for both voice & text input)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async function send() {
    const text = inputEl.value.trim();
    if (!text) return;

    inputEl.value = "";
    sendBtn.disabled = true;
    micBtn.disabled  = true;
    addMsg("user", text);

    history.push({ role: "user", content: text });

    showTyping();
    try {
      const res  = await fetch("/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ history }),
      });
      const data = await res.json();
      hideTyping();

      if (data.reply) {
        addMsg("bot", data.reply);
        history.push({ role: "assistant", content: data.reply });
        speak(data.reply);                        // ğŸ”Š auto-read in voice mode
      }
      if (data.receipt) renderReceipt(data.receipt);

    } catch (err) {
      hideTyping();
      addMsg("bot", "âš ï¸ Connection error â€” please try again.");
    }
    sendBtn.disabled = false;
    micBtn.disabled  = false;
    if (!voiceMode) inputEl.focus();
  }

  sendBtn.addEventListener("click", send);
  inputEl.addEventListener("keydown", e => { if (e.key === "Enter" && !e.shiftKey) send(); });

  // â”€â”€ Opening message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  window.addEventListener("DOMContentLoaded", () => {
    const greeting = "Ciao! ğŸ‘‹ Welcome to PizzaVoice! I'm Pino, your pizza waiter tonight.\nTap the mic and tell me what you'd like! ğŸ•ğŸ™ï¸";
    addMsg("bot", greeting);
    // Small delay so voices are loaded before first speech
    setTimeout(() => speak(greeting), 600);
  });
</script>
</body>
</html>