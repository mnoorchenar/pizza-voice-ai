<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ• PizzaVoice</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --red:    #e63946;
      --red-dk: #c1121f;
      --orange: #f4a261;
      --cream:  #fdf8f0;
      --dark:   #1d1d1d;
      --mid:    #444;
      --light:  #f1f1f1;
      --radius: 16px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
      background: var(--cream);
      color: var(--dark);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       LANDING OVERLAY
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #landing {
      position: fixed; inset: 0; z-index: 1000;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      background: linear-gradient(160deg, #1a1a2e 0%, #16213e 35%, #0f3460 70%, #e63946 100%);
      color: #fff;
      text-align: center;
      transition: opacity .6s ease, transform .6s ease;
    }
    #landing.hidden { opacity: 0; pointer-events: none; transform: scale(1.05); }
    .landing-pizza {
      font-size: 5rem;
      animation: float 3s ease-in-out infinite;
      filter: drop-shadow(0 8px 24px rgba(230,57,70,.4));
    }
    @keyframes float {
      0%,100% { transform: translateY(0) rotate(0deg); }
      50%     { transform: translateY(-14px) rotate(3deg); }
    }
    .landing-title {
      font-family: 'Playfair Display', serif;
      font-size: 3.2rem;
      margin: 20px 0 8px;
      letter-spacing: -1px;
      background: linear-gradient(135deg, #fff 30%, var(--orange));
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .landing-sub {
      font-size: 1.1rem;
      color: rgba(255,255,255,.7);
      max-width: 400px;
      line-height: 1.6;
      margin-bottom: 32px;
    }
    .landing-features {
      display: flex; gap: 28px;
      margin-bottom: 40px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .landing-feat {
      display: flex; flex-direction: column;
      align-items: center; gap: 6px;
      font-size: .85rem;
      color: rgba(255,255,255,.65);
    }
    .landing-feat .icon { font-size: 1.6rem; }
    #start-btn {
      padding: 16px 48px;
      border: none; border-radius: 50px;
      background: var(--red);
      color: #fff;
      font-size: 1.15rem;
      font-weight: 700;
      font-family: 'Inter', sans-serif;
      cursor: pointer;
      transition: background .2s, transform .15s, box-shadow .3s;
      box-shadow: 0 6px 30px rgba(230,57,70,.45);
      letter-spacing: .5px;
    }
    #start-btn:hover { background: var(--red-dk); transform: translateY(-2px); box-shadow: 0 10px 40px rgba(230,57,70,.55); }
    #start-btn:active { transform: scale(.97); }
    .landing-footer {
      position: absolute; bottom: 24px;
      font-size: .72rem;
      color: rgba(255,255,255,.3);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       HEADER
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    header {
      background: var(--red);
      color: #fff;
      padding: 14px 24px;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,.2);
    }
    header h1 { font-size: 1.4rem; font-weight: 700; }
    header span.logo { font-size: 1.8rem; }
    .status-dot {
      width: 10px; height: 10px;
      background: #4ade80;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:.4; } }
    .header-right {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    #mode-toggle {
      display: flex; align-items: center; gap: 6px;
      background: rgba(255,255,255,.18);
      border: 1.5px solid rgba(255,255,255,.35);
      border-radius: 24px;
      padding: 5px 14px;
      color: #fff; font-size: .82rem; font-weight: 600;
      cursor: pointer;
      transition: background .2s, border-color .2s;
      user-select: none;
    }
    #mode-toggle:hover { background: rgba(255,255,255,.28); }
    #mode-toggle .icon { font-size: 1.05rem; }
    #mode-toggle.voice-active { background: rgba(255,255,255,.32); border-color: #fff; }
    #voice-status {
      font-size: .72rem; padding: 3px 10px; border-radius: 12px;
      background: rgba(255,255,255,.15); color: rgba(255,255,255,.7);
      display: none;
    }
    #voice-status.listening { display:inline-block; background:rgba(74,222,128,.25); color:#4ade80; animation:pulse 1.5s infinite; }
    #voice-status.speaking  { display:inline-block; background:rgba(244,162,97,.25); color:var(--orange); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       MAIN LAYOUT
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    main { flex:1; display:flex; gap:0; overflow:hidden; }
    #chat-panel { flex:1; display:flex; flex-direction:column; min-width:0; }
    #messages {
      flex:1; overflow-y:auto; padding:20px;
      display:flex; flex-direction:column; gap:14px;
    }
    .msg {
      max-width:75%; padding:12px 16px; border-radius:var(--radius);
      line-height:1.5; font-size:.95rem; animation:fadein .25s ease;
    }
    @keyframes fadein { from { opacity:0; transform:translateY(6px); } to { opacity:1; } }
    .msg.bot { background:#fff; border:1px solid #e5e5e5; border-bottom-left-radius:4px; align-self:flex-start; }
    .msg.user { background:var(--red); color:#fff; border-bottom-right-radius:4px; align-self:flex-end; }
    .msg.bot .avatar { font-size:1.1rem; margin-right:6px; }
    .msg.bot .speak-btn {
      background:none; border:none; cursor:pointer;
      font-size:.85rem; margin-left:8px; opacity:.5;
      transition:opacity .2s; vertical-align:middle;
    }
    .msg.bot .speak-btn:hover { opacity:1; }
    .typing { display:flex; gap:5px; padding:14px 18px; align-items:center; }
    .typing span { width:8px; height:8px; background:#ccc; border-radius:50%; animation:bounce 1.2s infinite; }
    .typing span:nth-child(2) { animation-delay:.2s; }
    .typing span:nth-child(3) { animation-delay:.4s; }
    @keyframes bounce { 0%,80%,100% { transform:translateY(0); } 40% { transform:translateY(-8px); } }

    /* â”€â”€ Input bar â”€â”€ */
    #input-bar {
      padding:14px 20px; background:#fff; border-top:1px solid #e5e5e5;
      display:flex; gap:10px; align-items:center;
    }
    #user-input {
      flex:1; padding:12px 16px; border:1.5px solid #ddd;
      border-radius:30px; font-size:.95rem; outline:none;
      transition:border-color .2s;
    }
    #user-input:focus { border-color:var(--red); }
    #send-btn {
      background:var(--red); color:#fff; border:none;
      padding:12px 22px; border-radius:30px; font-size:.95rem;
      font-weight:600; cursor:pointer;
      transition:background .2s, transform .1s;
    }
    #send-btn:hover { background:#c1121f; }
    #send-btn:active { transform:scale(.97); }
    #send-btn:disabled { background:#aaa; cursor:not-allowed; }

    /* â”€â”€ Mic button â”€â”€ */
    #mic-btn {
      width:48px; height:48px; border-radius:50%; border:none;
      background:var(--red); color:#fff; font-size:1.3rem;
      cursor:pointer; flex-shrink:0; display:flex;
      align-items:center; justify-content:center;
      transition:background .2s, transform .15s, box-shadow .2s;
    }
    #mic-btn:hover { background:#c1121f; transform:scale(1.05); }
    #mic-btn:active { transform:scale(.95); }
    #mic-btn.recording {
      background:#22c55e;
      box-shadow:0 0 0 4px rgba(34,197,94,.3);
      animation:mic-pulse 1.2s infinite;
    }
    @keyframes mic-pulse {
      0%,100% { box-shadow:0 0 0 4px rgba(34,197,94,.3); }
      50%     { box-shadow:0 0 0 10px rgba(34,197,94,.08); }
    }
    #mic-btn:disabled { background:#aaa; cursor:not-allowed; box-shadow:none; animation:none; }
    body.voice-mode #user-input { display:none; }
    body.voice-mode #send-btn   { display:none; }
    body.voice-mode #mic-btn    { width:56px; height:56px; font-size:1.5rem; }
    body.text-mode  #mic-btn    { display:none; }
    #live-transcript {
      flex:1; font-size:.9rem; color:#999; font-style:italic;
      padding:0 12px; overflow:hidden; text-overflow:ellipsis; display:none;
    }
    body.voice-mode #live-transcript { display:block; }

    /* â”€â”€ Silence timer bar â”€â”€ */
    #silence-bar-wrap {
      height:3px; background:transparent; width:100%;
      position:relative; overflow:hidden; display:none;
    }
    #silence-bar-wrap.active { display:block; background:#e5e5e5; }
    #silence-bar {
      height:100%; width:0%; background:var(--red);
      transition: width linear;
    }

    /* â”€â”€ Receipt panel â”€â”€ */
    #receipt-panel {
      width:340px; background:#fff; border-left:1px solid #e5e5e5;
      display:flex; flex-direction:column; overflow-y:auto; transition:width .3s;
    }
    #receipt-panel.empty {
      display:flex; align-items:center; justify-content:center;
      color:#bbb; font-size:.9rem; text-align:center; padding:20px;
    }
    #receipt-panel.empty::after { content:"ğŸ•\nYour order receipt\nwill appear here"; white-space:pre; line-height:2; }
    #receipt-content { padding:20px; }
    .receipt-header { text-align:center; border-bottom:2px dashed #eee; padding-bottom:14px; margin-bottom:14px; }
    .receipt-header h2 { color:var(--red); font-size:1.3rem; }
    .receipt-header p { color:#888; font-size:.8rem; margin-top:4px; }
    .receipt-section { margin-bottom:12px; }
    .receipt-section h3 { font-size:.75rem; text-transform:uppercase; letter-spacing:.08em; color:#999; margin-bottom:6px; }
    .receipt-row { display:flex; justify-content:space-between; font-size:.9rem; padding:3px 0; }
    .receipt-row.total { font-weight:700; font-size:1.05rem; border-top:2px solid var(--dark); padding-top:8px; margin-top:4px; }
    .receipt-row.tax { color:#888; font-size:.85rem; }
    .topping-chip {
      display:inline-flex; align-items:center; gap:4px;
      background:var(--light); padding:3px 10px; border-radius:20px;
      font-size:.82rem; margin:3px 3px 3px 0;
    }
    .order-id { text-align:center; margin-top:16px; font-size:.78rem; color:#bbb; letter-spacing:.05em; }
    @media (max-width:640px) { #receipt-panel { width:0; overflow:hidden; border:none; } }
  </style>
</head>
<body class="voice-mode">

<!-- â•â•â•â•â•â•â•â•â•â•  LANDING PAGE  â•â•â•â•â•â•â•â•â•â• -->
<div id="landing">
  <div class="landing-pizza">ğŸ•</div>
  <h1 class="landing-title">PizzaVoice</h1>
  <p class="landing-sub">
    Your AI-powered pizza waiter. Just speak &mdash; Pino will take your order,
    suggest the perfect toppings, and handle everything by voice.
  </p>
  <div class="landing-features">
    <div class="landing-feat"><span class="icon">ğŸ™ï¸</span> Voice ordering</div>
    <div class="landing-feat"><span class="icon">ğŸ¤–</span> AI-powered</div>
    <div class="landing-feat"><span class="icon">ğŸ•</span> Full menu</div>
    <div class="landing-feat"><span class="icon">ğŸ§¾</span> Live receipt</div>
  </div>
  <button id="start-btn">ğŸ¤&ensp;Start Ordering</button>
  <p class="landing-footer">Powered by HuggingFace &bull; Free &amp; Open Source</p>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•  MAIN APP  â•â•â•â•â•â•â•â•â•â• -->
<header>
  <span class="logo">ğŸ•</span>
  <h1>PizzaVoice</h1>
  <div class="header-right">
    <span id="voice-status"></span>
    <button id="mode-toggle" class="voice-active" title="Switch between Voice and Text mode">
      <span class="icon">ğŸ™ï¸</span> <span id="mode-label">Voice</span>
    </button>
    <div class="status-dot" title="Online"></div>
  </div>
</header>

<main>
  <section id="chat-panel">
    <div id="messages"></div>
    <div id="silence-bar-wrap"><div id="silence-bar"></div></div>
    <div id="input-bar">
      <input id="user-input" type="text" placeholder="Type your messageâ€¦" autocomplete="off"/>
      <span id="live-transcript">Tap the mic &amp; speakâ€¦</span>
      <button id="mic-btn" title="Tap to speak">ğŸ¤</button>
      <button id="send-btn">Send</button>
    </div>
  </section>
  <aside id="receipt-panel" class="empty"></aside>
</main>

<script>
  /* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
     DOM REFS
     â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
  const messagesEl     = document.getElementById("messages");
  const inputEl        = document.getElementById("user-input");
  const sendBtn        = document.getElementById("send-btn");
  const receiptEl      = document.getElementById("receipt-panel");
  const micBtn         = document.getElementById("mic-btn");
  const modeToggle     = document.getElementById("mode-toggle");
  const modeLabel      = document.getElementById("mode-label");
  const voiceStatus    = document.getElementById("voice-status");
  const liveTranscript = document.getElementById("live-transcript");
  const landing        = document.getElementById("landing");
  const startBtn       = document.getElementById("start-btn");
  const silenceWrap    = document.getElementById("silence-bar-wrap");
  const silenceBar     = document.getElementById("silence-bar");

  let history   = [];
  let voiceMode = true;
  let appStarted = false;

  /* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
     LANDING PAGE
     â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
  startBtn.addEventListener("click", () => {
    landing.classList.add("hidden");
    setTimeout(() => { landing.style.display = "none"; }, 600);
    if (!appStarted) {
      appStarted = true;
      const greeting = "Ciao! Welcome to PizzaVoice! I'm Pino. What can I get for you today?";
      addMsg("bot", greeting);
      setTimeout(() => speakNatural(greeting), 400);
    }
  });

  /* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
     NATURAL TTS  (HF Inference API â†’ falls back to browser)
     â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
  let currentAudio   = null;
  let ttsEnabled     = true;
  let femaleVoice    = null;

  // Load browser voices as fallback
  function loadVoices() {
    const voices = speechSynthesis.getVoices();
    if (!voices.length) return;
    const prefs = [
      v => /zira/i.test(v.name),
      v => /samantha/i.test(v.name),
      v => /google.*female/i.test(v.name),
      v => /female/i.test(v.name) && /en/i.test(v.lang),
      v => (/en[-_]/i.test(v.lang)) && !/(male|david|mark|james|daniel|guy|richard)/i.test(v.name),
      v => /en[-_]/i.test(v.lang),
    ];
    for (const test of prefs) {
      const m = voices.find(test);
      if (m) { femaleVoice = m; break; }
    }
    if (!femaleVoice) femaleVoice = voices[0];
  }
  speechSynthesis.addEventListener("voiceschanged", loadVoices);
  loadVoices();

  function browserSpeak(text) {
    speechSynthesis.cancel();
    const clean = text.replace(/[#*_~`>]/g,"").replace(/\bhttps?:\/\/\S+/g,"link");
    const utt = new SpeechSynthesisUtterance(clean);
    if (femaleVoice) utt.voice = femaleVoice;
    utt.rate = 1.02; utt.pitch = 1.12; utt.lang = "en-US";
    utt.onstart = () => setVoiceStatus("speaking","ğŸ”Š Speakingâ€¦");
    utt.onend   = () => setVoiceStatus("idle");
    utt.onerror = () => setVoiceStatus("idle");
    speechSynthesis.speak(utt);
  }

  async function speakNatural(text) {
    if (!ttsEnabled || !voiceMode) return;
    stopSpeaking();
    setVoiceStatus("speaking","ğŸ”Š Speakingâ€¦");

    try {
      const res = await fetch("/tts", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({text}),
      });
      if (!res.ok) throw new Error("TTS endpoint returned " + res.status);
      const blob = await res.blob();
      if (blob.size < 100) throw new Error("Empty audio");

      const url = URL.createObjectURL(blob);
      currentAudio = new Audio(url);
      currentAudio.onended = () => { setVoiceStatus("idle"); URL.revokeObjectURL(url); currentAudio = null; };
      currentAudio.onerror = () => { setVoiceStatus("idle"); URL.revokeObjectURL(url); currentAudio = null; browserSpeak(text); };
      currentAudio.play();
    } catch(e) {
      console.warn("[TTS] HF failed, falling back to browser:", e.message);
      browserSpeak(text);
    }
  }

  function stopSpeaking() {
    if (currentAudio) { currentAudio.pause(); currentAudio = null; }
    speechSynthesis.cancel();
    setVoiceStatus("idle");
  }

  /* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
     SPEECH-TO-TEXT  â€” continuous + 2-second silence detection
     â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  let recognition   = null;
  let isRecording   = false;
  let silenceTimer  = null;
  let accumulated   = "";            // final transcript pieces
  let interimText   = "";            // current interim
  const SILENCE_MS  = 2000;          // wait 2 seconds of silence

  if (SpeechRecognition) {
    recognition = new SpeechRecognition();
    recognition.continuous     = true;       // keep listening
    recognition.interimResults = true;
    recognition.lang           = "en-US";

    recognition.onresult = (e) => {
      let interim = "", final_ = "";
      for (let i = e.resultIndex; i < e.results.length; i++) {
        const t = e.results[i][0].transcript;
        if (e.results[i].isFinal) final_ += t;
        else                      interim += t;
      }
      if (final_) accumulated += (accumulated ? " " : "") + final_.trim();
      interimText = interim;
      liveTranscript.textContent = (accumulated + " " + interim).trim() || "Listeningâ€¦";

      // Reset the silence timer every time we get new speech
      clearSilenceTimer();
      if (accumulated || interim) startSilenceTimer();
    };

    recognition.onerror = (e) => {
      console.warn("[STT] Error:", e.error);
      if (e.error === "not-allowed") {
        stopRecording();
        addMsg("bot","âš ï¸ Microphone access was denied. Please allow mic or switch to Text mode.");
      }
      // For "no-speech" or "network" errors, just keep going
      if (e.error === "aborted") stopRecording();
    };

    recognition.onend = () => {
      // If still in recording mode, auto-restart (browser sometimes stops)
      if (isRecording) {
        try { recognition.start(); } catch(_) {}
      }
    };
  }

  function startSilenceTimer() {
    clearSilenceTimer();
    silenceWrap.classList.add("active");
    silenceBar.style.transition = "none";
    silenceBar.style.width = "0%";
    // Force reflow, then animate
    silenceBar.offsetWidth;
    silenceBar.style.transition = `width ${SILENCE_MS}ms linear`;
    silenceBar.style.width = "100%";

    silenceTimer = setTimeout(() => {
      // 2 seconds of silence â€” send what we have
      if (accumulated.trim()) {
        inputEl.value = accumulated.trim();
        accumulated = "";
        interimText = "";
        stopRecording();
        send();
      }
      hideSilenceBar();
    }, SILENCE_MS);
  }

  function clearSilenceTimer() {
    if (silenceTimer) { clearTimeout(silenceTimer); silenceTimer = null; }
    hideSilenceBar();
  }

  function hideSilenceBar() {
    silenceWrap.classList.remove("active");
    silenceBar.style.transition = "none";
    silenceBar.style.width = "0%";
  }

  function startRecording() {
    if (!recognition) {
      addMsg("bot","âš ï¸ Your browser doesn't support speech recognition. Switch to Text mode.");
      return;
    }
    stopSpeaking();
    accumulated = "";
    interimText = "";
    isRecording = true;
    micBtn.classList.add("recording");
    liveTranscript.textContent = "Listeningâ€¦";
    setVoiceStatus("listening","ğŸ™ï¸ Listeningâ€¦");
    try { recognition.start(); } catch(_) {}
  }

  function stopRecording() {
    isRecording = false;
    clearSilenceTimer();
    micBtn.classList.remove("recording");
    liveTranscript.textContent = "Tap the mic & speakâ€¦";
    setVoiceStatus("idle");
    try { recognition.stop(); } catch(_) {}
  }

  micBtn.addEventListener("click", () => {
    if (isRecording) stopRecording();
    else             startRecording();
  });

  /* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
     MODE TOGGLE
     â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
  function setMode(mode) {
    voiceMode = mode === "voice";
    document.body.className = voiceMode ? "voice-mode" : "text-mode";
    modeLabel.textContent   = voiceMode ? "Voice" : "Text";
    modeToggle.querySelector(".icon").textContent = voiceMode ? "ğŸ™ï¸" : "âŒ¨ï¸";
    modeToggle.classList.toggle("voice-active", voiceMode);
    if (!voiceMode) { stopRecording(); stopSpeaking(); setVoiceStatus("idle"); inputEl.focus(); }
  }
  modeToggle.addEventListener("click", () => setMode(voiceMode ? "text" : "voice"));

  /* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
     VOICE STATUS
     â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
  function setVoiceStatus(state, label) {
    voiceStatus.className = "";
    voiceStatus.style.display = "none";
    if (state === "listening") {
      voiceStatus.textContent = label || "ğŸ™ï¸ Listeningâ€¦";
      voiceStatus.className = "listening"; voiceStatus.style.display = "inline-block";
    } else if (state === "speaking") {
      voiceStatus.textContent = label || "ğŸ”Š Speakingâ€¦";
      voiceStatus.className = "speaking"; voiceStatus.style.display = "inline-block";
    }
  }

  /* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
     CHAT RENDERING
     â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
  function addMsg(role, text) {
    const div = document.createElement("div");
    div.className = `msg ${role}`;
    if (role === "bot") {
      div.innerHTML = `<span class="avatar">ğŸ‘©â€ğŸ³</span>${escHtml(text)}<button class="speak-btn" title="Read aloud">ğŸ”Š</button>`;
      div.querySelector(".speak-btn").addEventListener("click", () => {
        ttsEnabled = true;
        const was = voiceMode; voiceMode = true;
        speakNatural(text);
        voiceMode = was;
      });
    } else {
      div.textContent = text;
    }
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;
    return div;
  }

  function escHtml(s) {
    return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>");
  }

  function showTyping() {
    const d = document.createElement("div");
    d.className = "msg bot typing"; d.id = "typing";
    d.innerHTML = "<span></span><span></span><span></span>";
    messagesEl.appendChild(d); messagesEl.scrollTop = messagesEl.scrollHeight;
  }
  function hideTyping() { const t = document.getElementById("typing"); if (t) t.remove(); }

  /* â”€â”€ Receipt â”€â”€ */
  function renderReceipt(r) {
    receiptEl.classList.remove("empty");
    const o = r.order, p = r.pricing;
    const fmt = n => `$${n.toFixed(2)}`;
    let topsHtml = o.toppings.length
      ? o.toppings.map(t=>`<span class="topping-chip">${t.emoji} ${t.label} <em style="color:#999">${fmt(t.price)}</em></span>`).join("")
      : `<span style="color:#bbb;font-size:.85rem">None</span>`;
    let drinksHtml = (o.drinks && o.drinks.length)
      ? o.drinks.map(d=>`<span class="topping-chip">${d.emoji} ${d.label} <em style="color:#999">${fmt(d.price)}</em></span>`).join("")
      : `<span style="color:#bbb;font-size:.85rem">None</span>`;
    let extrasHtml = o.extras.length
      ? o.extras.map(e=>`<div class="receipt-row"><span>${e.label}</span><span>${e.price?fmt(e.price):"free"}</span></div>`).join("") : "";

    receiptEl.innerHTML = `<div id="receipt-content">
      <div class="receipt-header">
        <h2>ğŸ• Order Confirmed!</h2>
        <p>${r.timestamp}</p>
        <p style="margin-top:6px;font-size:.9rem">Hey <strong>${o.name}</strong>! Here's your order ğŸ‘‡</p>
      </div>
      <div class="receipt-section">
        <h3>Pizza Details</h3>
        <div class="receipt-row"><span>Size</span><span>${o.size.label}</span></div>
        <div class="receipt-row"><span>Crust</span><span>${o.crust.label}</span></div>
        <div class="receipt-row"><span>Sauce</span><span>${o.sauce.label}</span></div>
        <div class="receipt-row"><span>Cheese</span><span>${o.cheese.label}</span></div>
        <div class="receipt-row"><span>Qty</span><span>Ã— ${o.quantity}</span></div>
      </div>
      <div class="receipt-section"><h3>Toppings</h3><div>${topsHtml}</div></div>
      <div class="receipt-section"><h3>ğŸ¥¤ Drinks</h3><div>${drinksHtml}</div></div>
      ${extrasHtml ? `<div class="receipt-section"><h3>Extras</h3>${extrasHtml}</div>` : ""}
      <div class="receipt-section">
        <h3>ğŸ“ Delivery Address</h3>
        <p style="font-size:.9rem;color:var(--mid);line-height:1.5">${escHtml(o.address||'Pick-up')}</p>
      </div>
      <div class="receipt-section">
        <h3>Pricing</h3>
        <div class="receipt-row"><span>Base price</span><span>${fmt(p.breakdown.base)}</span></div>
        ${p.breakdown.crust?`<div class="receipt-row"><span>Crust upgrade</span><span>+${fmt(p.breakdown.crust)}</span></div>`:""}
        ${p.breakdown.sauce?`<div class="receipt-row"><span>Sauce upgrade</span><span>+${fmt(p.breakdown.sauce)}</span></div>`:""}
        ${p.breakdown.cheese?`<div class="receipt-row"><span>Cheese upgrade</span><span>+${fmt(p.breakdown.cheese)}</span></div>`:""}
        ${p.breakdown.toppings?`<div class="receipt-row"><span>Toppings</span><span>+${fmt(p.breakdown.toppings)}</span></div>`:""}
        ${p.breakdown.drinks?`<div class="receipt-row"><span>Drinks</span><span>+${fmt(p.breakdown.drinks)}</span></div>`:""}
        ${p.breakdown.extras?`<div class="receipt-row"><span>Extras</span><span>+${fmt(p.breakdown.extras)}</span></div>`:""}
        ${p.quantity>1?`<div class="receipt-row"><span>Unit Ã— ${p.quantity}</span><span>${fmt(p.unit)} Ã— ${p.quantity}</span></div>`:""}
        <div class="receipt-row"><span>Subtotal</span><span>${fmt(p.subtotal)}</span></div>
        <div class="receipt-row tax"><span>Tax (13%)</span><span>${fmt(p.tax)}</span></div>
        <div class="receipt-row total"><span>ğŸ’° Total Due</span><span style="color:var(--red);font-size:1.15rem">${fmt(p.total)}</span></div>
      </div>
      <div style="text-align:center;margin:16px 0 8px;padding:12px 10px;background:linear-gradient(135deg,#fff8f0,#fff3e0);border-radius:12px;border:1px dashed var(--orange)">
        <p style="font-style:italic;font-size:.88rem;color:var(--mid);line-height:1.6">${escHtml(r.quote||'')}</p>
      </div>
      <div class="order-id">Order #${r.order_id}</div>
    </div>`;
  }

  /* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
     SEND MESSAGE
     â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
  async function send() {
    const text = inputEl.value.trim();
    if (!text) return;
    inputEl.value = "";
    sendBtn.disabled = true;
    micBtn.disabled  = true;
    addMsg("user", text);
    history.push({role:"user", content:text});

    showTyping();
    try {
      const res  = await fetch("/chat", {
        method:"POST", headers:{"Content-Type":"application/json"},
        body:JSON.stringify({history}),
      });
      const data = await res.json();
      hideTyping();
      if (data.reply) {
        addMsg("bot", data.reply);
        history.push({role:"assistant", content:data.reply});
        speakNatural(data.reply);
      }
      if (data.receipt) renderReceipt(data.receipt);
    } catch(err) {
      hideTyping();
      addMsg("bot","âš ï¸ Connection error â€” please try again.");
    }
    sendBtn.disabled = false;
    micBtn.disabled  = false;
    if (!voiceMode) inputEl.focus();
  }

  sendBtn.addEventListener("click", send);
  inputEl.addEventListener("keydown", e => { if(e.key==="Enter" && !e.shiftKey) send(); });
</script>
</body>
</html>