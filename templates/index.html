<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ• PizzaVoice</title>
  <style>
    :root {
      --red:    #e63946;
      --orange: #f4a261;
      --cream:  #fdf8f0;
      --dark:   #1d1d1d;
      --mid:    #444;
      --light:  #f1f1f1;
      --radius: 16px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: var(--cream);
      color: var(--dark);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* â”€â”€ Header â”€â”€ */
    header {
      background: var(--red);
      color: #fff;
      padding: 14px 24px;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,.2);
    }
    header h1 { font-size: 1.4rem; font-weight: 700; }
    header span { font-size: 1.8rem; }
    .status-dot {
      width: 10px; height: 10px;
      background: #4ade80;
      border-radius: 50%;
      margin-left: auto;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%,100% { opacity: 1; } 50% { opacity: .4; }
    }

    /* â”€â”€ Main layout â”€â”€ */
    main {
      flex: 1;
      display: flex;
      gap: 0;
      overflow: hidden;
    }

    /* â”€â”€ Chat panel â”€â”€ */
    #chat-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }
    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    .msg {
      max-width: 75%;
      padding: 12px 16px;
      border-radius: var(--radius);
      line-height: 1.5;
      font-size: .95rem;
      animation: fadein .25s ease;
    }
    @keyframes fadein { from { opacity:0; transform:translateY(6px); } to { opacity:1; } }
    .msg.bot {
      background: #fff;
      border: 1px solid #e5e5e5;
      border-bottom-left-radius: 4px;
      align-self: flex-start;
    }
    .msg.user {
      background: var(--red);
      color: #fff;
      border-bottom-right-radius: 4px;
      align-self: flex-end;
    }
    .msg.bot .avatar {
      font-size: 1.1rem;
      margin-right: 6px;
    }

    /* typing indicator */
    .typing { display: flex; gap: 5px; padding: 14px 18px; align-items: center; }
    .typing span {
      width: 8px; height: 8px;
      background: #ccc;
      border-radius: 50%;
      animation: bounce 1.2s infinite;
    }
    .typing span:nth-child(2) { animation-delay: .2s; }
    .typing span:nth-child(3) { animation-delay: .4s; }
    @keyframes bounce {
      0%,80%,100% { transform: translateY(0); }
      40%          { transform: translateY(-8px); }
    }

    /* â”€â”€ Input bar â”€â”€ */
    #input-bar {
      padding: 14px 20px;
      background: #fff;
      border-top: 1px solid #e5e5e5;
      display: flex;
      gap: 10px;
    }
    #user-input {
      flex: 1;
      padding: 12px 16px;
      border: 1.5px solid #ddd;
      border-radius: 30px;
      font-size: .95rem;
      outline: none;
      transition: border-color .2s;
    }
    #user-input:focus { border-color: var(--red); }
    #send-btn {
      background: var(--red);
      color: #fff;
      border: none;
      padding: 12px 22px;
      border-radius: 30px;
      font-size: .95rem;
      font-weight: 600;
      cursor: pointer;
      transition: background .2s, transform .1s;
    }
    #send-btn:hover  { background: #c1121f; }
    #send-btn:active { transform: scale(.97); }
    #send-btn:disabled { background: #aaa; cursor: not-allowed; }

    /* â”€â”€ Receipt panel â”€â”€ */
    #receipt-panel {
      width: 340px;
      background: #fff;
      border-left: 1px solid #e5e5e5;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      transition: width .3s;
    }
    #receipt-panel.empty {
      display: flex;
      align-items: center;
      justify-content: center;
      color: #bbb;
      font-size: .9rem;
      text-align: center;
      padding: 20px;
    }
    #receipt-panel.empty::after {
      content: "ğŸ•\nYour order receipt\nwill appear here";
      white-space: pre;
      line-height: 2;
    }
    #receipt-content { padding: 20px; }
    .receipt-header {
      text-align: center;
      border-bottom: 2px dashed #eee;
      padding-bottom: 14px;
      margin-bottom: 14px;
    }
    .receipt-header h2 { color: var(--red); font-size: 1.3rem; }
    .receipt-header p  { color: #888; font-size: .8rem; margin-top: 4px; }
    .receipt-section   { margin-bottom: 12px; }
    .receipt-section h3 {
      font-size: .75rem;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: #999;
      margin-bottom: 6px;
    }
    .receipt-row {
      display: flex;
      justify-content: space-between;
      font-size: .9rem;
      padding: 3px 0;
    }
    .receipt-row.total {
      font-weight: 700;
      font-size: 1.05rem;
      border-top: 2px solid var(--dark);
      padding-top: 8px;
      margin-top: 4px;
    }
    .receipt-row.tax { color: #888; font-size: .85rem; }
    .topping-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: var(--light);
      padding: 3px 10px;
      border-radius: 20px;
      font-size: .82rem;
      margin: 3px 3px 3px 0;
    }
    .order-id {
      text-align: center;
      margin-top: 16px;
      font-size: .78rem;
      color: #bbb;
      letter-spacing: .05em;
    }

    /* â”€â”€ Responsive â”€â”€ */
    @media (max-width: 640px) {
      #receipt-panel { width: 0; overflow: hidden; border: none; }
    }
  </style>
</head>
<body>

<header>
  <span>ğŸ•</span>
  <h1>PizzaVoice</h1>
  <div class="status-dot" title="Online"></div>
</header>

<main>
  <!-- Chat -->
  <section id="chat-panel">
    <div id="messages"></div>
    <div id="input-bar">
      <input id="user-input" type="text" placeholder="Say anything â€” Pino is listeningâ€¦" autocomplete="off"/>
      <button id="send-btn">Send</button>
    </div>
  </section>

  <!-- Receipt -->
  <aside id="receipt-panel" class="empty"></aside>
</main>

<script>
  const messagesEl  = document.getElementById("messages");
  const inputEl     = document.getElementById("user-input");
  const sendBtn     = document.getElementById("send-btn");
  const receiptEl   = document.getElementById("receipt-panel");

  // Conversation history sent to backend
  let history = [];

  // â”€â”€ Render a chat bubble â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function addMsg(role, text) {
    const div = document.createElement("div");
    div.className = `msg ${role}`;
    if (role === "bot") div.innerHTML = `<span class="avatar">ğŸ‘¨â€ğŸ³</span>${escHtml(text)}`;
    else                div.textContent = text;
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;
    return div;
  }

  function escHtml(s) {
    return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
            .replace(/\n/g,"<br>");
  }

  // â”€â”€ Typing indicator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showTyping() {
    const d = document.createElement("div");
    d.className = "msg bot typing";
    d.id = "typing";
    d.innerHTML = "<span></span><span></span><span></span>";
    messagesEl.appendChild(d);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }
  function hideTyping() {
    const t = document.getElementById("typing");
    if (t) t.remove();
  }

  // â”€â”€ Render receipt â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderReceipt(r) {
    receiptEl.classList.remove("empty");
    const o = r.order, p = r.pricing;
    const fmt = n => `$${n.toFixed(2)}`;

    let topsHtml = o.toppings.length
      ? o.toppings.map(t=>`<span class="topping-chip">${t.emoji} ${t.label} <em style="color:#999">${fmt(t.price)}</em></span>`).join("")
      : `<span style="color:#bbb;font-size:.85rem">None</span>`;

    let extrasHtml = o.extras.length
      ? o.extras.map(e=>`<div class="receipt-row"><span>${e.label}</span><span>${e.price?fmt(e.price):"free"}</span></div>`).join("")
      : "";

    receiptEl.innerHTML = `<div id="receipt-content">
      <div class="receipt-header">
        <h2>ğŸ• Order Confirmed!</h2>
        <p>${r.timestamp}</p>
        <p style="margin-top:6px;font-size:.9rem">Hey <strong>${o.name}</strong>! Here's your order ğŸ‘‡</p>
      </div>

      <div class="receipt-section">
        <h3>Pizza Details</h3>
        <div class="receipt-row"><span>Size</span><span>${o.size.label}</span></div>
        <div class="receipt-row"><span>Crust</span><span>${o.crust.label}</span></div>
        <div class="receipt-row"><span>Sauce</span><span>${o.sauce.label}</span></div>
        <div class="receipt-row"><span>Cheese</span><span>${o.cheese.label}</span></div>
        <div class="receipt-row"><span>Qty</span><span>Ã— ${o.quantity}</span></div>
      </div>

      <div class="receipt-section">
        <h3>Toppings</h3>
        <div>${topsHtml}</div>
      </div>

      ${extrasHtml ? `<div class="receipt-section"><h3>Extras</h3>${extrasHtml}</div>` : ""}

      <div class="receipt-section">
        <h3>Pricing</h3>
        <div class="receipt-row"><span>Base price</span><span>${fmt(p.breakdown.base)}</span></div>
        ${p.breakdown.crust   ? `<div class="receipt-row"><span>Crust upgrade</span><span>+${fmt(p.breakdown.crust)}</span></div>` : ""}
        ${p.breakdown.sauce   ? `<div class="receipt-row"><span>Sauce upgrade</span><span>+${fmt(p.breakdown.sauce)}</span></div>` : ""}
        ${p.breakdown.cheese  ? `<div class="receipt-row"><span>Cheese upgrade</span><span>+${fmt(p.breakdown.cheese)}</span></div>` : ""}
        ${p.breakdown.toppings? `<div class="receipt-row"><span>Toppings</span><span>+${fmt(p.breakdown.toppings)}</span></div>` : ""}
        ${p.breakdown.extras  ? `<div class="receipt-row"><span>Extras</span><span>+${fmt(p.breakdown.extras)}</span></div>` : ""}
        ${p.quantity > 1      ? `<div class="receipt-row"><span>Unit price Ã— ${p.quantity}</span><span>${fmt(p.unit)} Ã— ${p.quantity}</span></div>` : ""}
        <div class="receipt-row"><span>Subtotal</span><span>${fmt(p.subtotal)}</span></div>
        <div class="receipt-row tax"><span>Tax (13%)</span><span>${fmt(p.tax)}</span></div>
        <div class="receipt-row total"><span>Total</span><span>${fmt(p.total)}</span></div>
      </div>

      <div class="order-id">Order #${r.order_id}</div>
    </div>`;
  }

  // â”€â”€ Send message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function send() {
    const text = inputEl.value.trim();
    if (!text) return;

    inputEl.value = "";
    sendBtn.disabled = true;
    addMsg("user", text);

    // push to history
    history.push({ role: "user", content: text });

    showTyping();
    try {
      const res  = await fetch("/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ history }),
      });
      const data = await res.json();
      hideTyping();

      if (data.reply) {
        addMsg("bot", data.reply);
        history.push({ role: "assistant", content: data.reply });
      }
      if (data.receipt) renderReceipt(data.receipt);

    } catch (err) {
      hideTyping();
      addMsg("bot", "âš ï¸ Connection error â€” please try again.");
    }
    sendBtn.disabled = false;
    inputEl.focus();
  }

  sendBtn.addEventListener("click", send);
  inputEl.addEventListener("keydown", e => { if (e.key === "Enter" && !e.shiftKey) send(); });

  // â”€â”€ Opening message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  window.addEventListener("DOMContentLoaded", () => {
    addMsg("bot", "Ciao! ğŸ‘‹ Welcome to PizzaVoice! I'm Pino, your pizza waiter tonight.\nWhat can I build for you? ğŸ•");
  });
</script>
</body>
</html>